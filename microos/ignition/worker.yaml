variant: fcos
version: 1.5.0
systemd:
  units:
    - name: sshd.service
      enabled: true
    - name: crio.service
      enabled: true
    - name: kubelet.service
      enabled: true
    - name: packages.service
      enabled: true
      contents: |
        [Unit]
        Description=Install os packages
        Wants=network-online.target
        After=network-online.target

        [Service]
        Environment=CRI_O_VERSION=1.24.3
        Environment=KUBERNETES_VERSION=1.31.1
        Environment=SOCAT_VERSION=1.8.0.0
        Environment=EBTABLES_VERSION=2.0.11
        Restart=on-failure
        RestartSec=30
        RemainAfterExit=yes
        ExecStart=/bin/bash -c "zypper --gpg-auto-import-keys ref && transactional-update reboot --non-interactive pkg install cri-o-${CRI_O_VERSION} kubeadm-${KUBERNETES_VERSION} kubelet-${KUBERNETES_VERSION} socat-${SOCAT_VERSION} ebtables-${EBTABLES_VERSION}"

        [Install]
        WantedBy=multi-user.target
passwd:
  users:
    - name: root
      password_hash: # create password and set hash here, with openssl passwd -6
      ssh_authorized_keys:
        -  # set_contents_of_public_key
storage:
  files:
    - path: /etc/selinux/config
      mode: 0644
      overwrite: true
      contents:
        inline: |
          SELINUX=permissive
          SELINUXTYPE=targeted
    - path: /etc/zypp/repos.d/kubernetes.repo
      mode: 0644
      overwrite: true
      contents:
        inline: |
          [kubernetes]
          name=Kubernetes
          baseurl=https://pkgs.k8s.io/core:/stable:/v1.31/rpm/
          enabled=1
          gpgcheck=1
          gpgkey=https://pkgs.k8s.io/core:/stable:/v1.31/rpm/repodata/repomd.xml.key
          exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
    - path: /etc/sysctl.d/99-kubernetes.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          net.bridge.bridge-nf-call-iptables=1
          net.ipv4.ip_forward=1
          net.bridge.bridge-nf-call-ip6tables=1
    - path: /etc/modules-load.d/99-kubernetes.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          overlay
          br_netfilter
    - path: /etc/containers/policy.json
      mode: 0644
      overwrite: true
      contents:
        inline: |
          {
            "default": [{
                "type": "insecureAcceptAnything"
              }],
            "transports": {
              "docker-daemon": {
                "": [{
                    "type": "insecureAcceptAnything"
                  }]
              },
              "docker": {}
            }
          }
  links:
    - path: /etc/localtime
      overwrite: true
      target: /usr/share/zoneinfo/Europe/Amsterdam
    - path: /etc/systemd/system/multi-user.target.wants/crio.service
      overwrite: true
      target: /usr/lib/systemd/system/crio.service
    - path: /etc/systemd/system/multi-user.target.wants/kubelet.service
      overwrite: true
      target: /usr/lib/systemd/system/kubelet.service